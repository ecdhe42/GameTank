#include "gametank.h"
#include "drawing_funcs.h"
#include "input.h"
#include "persist.h"
#include "music.h"
#include "banking.h"
#include "gen/assets/crash.h"
#include "gen/assets/sfx.h"

#pragma data-name (push, "SAVE")
char saved_pos[4] = {30, 40, 1, 1};
#pragma data-name (pop)

char tracks[20][64] = {
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,16,81,82,83,20,21,22,23,88,89,90,91,28,29,30,31,32,97,98,99,100,101,102,39,40,41,42,43,44,45,110,111,112,113,114,115,116,117,54,55,56,57,58,59,60,61,62,63},
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,16,81,82,83,20,21,22,23,88,89,90,91,28,29,30,31,32,97,98,99,100,101,102,39,40,41,42,43,44,45,110,111,112,113,114,115,116,117,118,55,56,57,58,59,60,61,62,63},
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,16,81,82,83,20,21,22,23,88,89,90,91,92,29,30,31,32,33,98,99,100,101,102,103,40,41,42,43,44,45,46,111,112,113,114,115,116,117,118,119,56,57,58,59,60,61,62,63},
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,16,81,82,83,20,21,22,23,88,89,90,91,92,29,30,31,32,33,98,99,100,101,102,103,40,41,42,43,44,45,46,47,112,113,114,115,116,117,118,119,120,57,58,59,60,61,62,63},
{0,65,2,67,4,69,6,71,8,73,74,11,12,77,78,15,16,17,82,83,84,21,22,23,24,89,90,91,92,93,30,31,32,33,34,99,100,101,102,103,104,41,42,43,44,45,46,47,48,113,114,115,116,117,118,119,120,121,58,59,60,61,62,63},
{0,65,2,67,4,69,6,71,8,73,74,11,12,77,78,15,16,17,82,83,84,21,22,23,24,89,90,91,92,93,30,31,32,33,34,99,100,101,102,103,104,105,42,43,44,45,46,47,48,49,114,115,116,117,118,119,120,121,122,59,60,61,62,63},
{0,65,2,67,4,69,6,71,8,73,74,11,12,77,78,15,16,17,82,83,84,21,22,23,24,89,90,91,92,93,30,31,32,33,34,35,100,101,102,103,104,105,106,43,44,45,46,47,48,49,50,115,116,117,118,119,120,121,122,123,60,61,62,63},
{0,65,2,67,4,69,6,71,8,73,74,11,12,77,78,15,16,17,82,83,84,21,22,23,24,89,90,91,92,93,30,31,32,33,34,35,100,101,102,103,104,105,106,43,44,45,46,47,48,49,50,115,116,117,118,119,120,121,122,123,124,61,62,63},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,16,17,18,83,84,85,22,23,24,25,90,91,92,93,94,31,32,33,34,35,36,101,102,103,104,105,106,107,44,45,46,47,48,49,50,51,116,117,118,119,120,121,122,123,124,125,62,63},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,16,17,18,83,84,85,86,23,24,25,26,91,92,93,94,95,32,33,34,35,36,37,102,103,104,105,106,107,108,45,46,47,48,49,50,51,52,117,118,119,120,121,122,123,124,125,126,63},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,80,17,18,19,84,85,86,87,24,25,26,27,92,93,94,95,96,33,34,35,36,37,38,103,104,105,106,107,108,109,46,47,48,49,50,51,52,53,118,119,120,121,122,123,124,125,126,127},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,80,17,18,19,84,85,86,87,24,25,26,27,92,93,94,95,96,33,34,35,36,37,38,103,104,105,106,107,108,109,46,47,48,49,50,51,52,53,54,119,120,121,122,123,124,125,126,127},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,80,17,18,19,84,85,86,87,24,25,26,27,28,93,94,95,96,97,34,35,36,37,38,39,104,105,106,107,108,109,110,47,48,49,50,51,52,53,54,55,120,121,122,123,124,125,126,127},
{0,65,2,67,4,69,6,71,8,9,74,75,12,13,78,79,80,17,18,19,84,85,86,87,24,25,26,27,28,93,94,95,96,97,34,35,36,37,38,39,104,105,106,107,108,109,110,111,48,49,50,51,52,53,54,55,56,121,122,123,124,125,126,127},
{64,1,66,3,68,5,70,7,72,9,10,75,76,13,14,79,80,81,18,19,20,85,86,87,88,25,26,27,28,29,94,95,96,97,98,35,36,37,38,39,40,105,106,107,108,109,110,111,112,49,50,51,52,53,54,55,56,57,122,123,124,125,126,127},
{64,1,66,3,68,5,70,7,72,9,10,75,76,13,14,79,80,81,18,19,20,85,86,87,88,25,26,27,28,29,94,95,96,97,98,35,36,37,38,39,40,41,106,107,108,109,110,111,112,113,50,51,52,53,54,55,56,57,58,123,124,125,126,127},
{64,1,66,3,68,5,70,7,72,9,10,75,76,13,14,79,80,81,18,19,20,85,86,87,88,25,26,27,28,29,94,95,96,97,98,99,36,37,38,39,40,41,42,107,108,109,110,111,112,113,114,51,52,53,54,55,56,57,58,59,124,125,126,127},
{64,1,66,3,68,5,70,7,72,9,10,75,76,13,14,79,80,81,18,19,20,85,86,87,88,25,26,27,28,29,94,95,96,97,98,99,36,37,38,39,40,41,42,107,108,109,110,111,112,113,114,51,52,53,54,55,56,57,58,59,60,125,126,127},
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,80,81,82,19,20,21,86,87,88,89,26,27,28,29,30,95,96,97,98,99,100,37,38,39,40,41,42,43,108,109,110,111,112,113,114,115,52,53,54,55,56,57,58,59,60,61,126,127},
{64,1,66,3,68,5,70,7,72,73,10,11,76,77,14,15,80,81,82,19,20,21,22,87,88,89,90,27,28,29,30,31,96,97,98,99,100,101,38,39,40,41,42,43,44,109,110,111,112,113,114,115,116,53,54,55,56,57,58,59,60,61,62,127}
};

char track_width[64] = {
    4,6,8,9,11,13,15,17,18,20,22,24,26,28,29,31,33,35,37,38,40,42,44,46,48,49,51,53,55,57,58,60,62,64,66,67,69,71,73,75,76,78,80,82,84,86,87,89,91,93,95,96,98,100,102,104,106,107,109,111,113,115,116,118
};

char track_x_shifts[9][64] = {
{5,7,9,12,13,16,17,19,20,21,22,23,24,24,26,25,27,26,27,27,27,27,27,27,27,28,26,27,26,26,26,25,25,24,24,23,23,22,22,20,21,20,19,18,18,17,16,16,14,15,13,13,12,11,10,9,8,8,8,6,6,4,4,3},
{17,19,20,22,23,25,24,26,27,27,28,28,29,29,30,29,30,29,30,30,30,30,29,29,29,29,28,28,27,27,27,26,26,25,24,24,24,22,23,21,21,20,19,19,18,17,16,16,15,15,13,13,12,11,10,9,8,8,8,6,6,4,4,3},
{31,32,32,33,33,34,33,34,35,35,35,34,34,34,35,34,34,33,34,33,33,32,32,31,31,31,30,30,28,29,28,27,27,26,25,24,25,23,23,21,22,21,20,19,18,17,16,17,15,15,13,13,12,11,10,9,9,8,8,6,6,4,4,3},
{44,44,43,44,43,43,42,43,42,42,41,41,40,40,40,38,39,37,37,37,36,35,35,34,33,33,32,32,30,30,30,29,28,27,26,25,26,24,24,22,22,21,20,20,19,18,17,17,15,15,13,13,12,11,11,10,9,8,8,6,6,4,4,3},
{62,61,60,60,58,58,56,56,55,54,53,52,51,50,50,48,48,46,46,45,44,43,42,41,40,40,38,38,36,36,35,34,33,32,31,30,30,28,28,26,26,25,24,23,22,21,20,20,18,18,16,16,15,14,13,12,11,10,10,8,8,6,6,5},
{78,76,75,74,71,71,68,67,66,64,63,61,60,58,58,56,55,53,53,51,50,49,47,46,45,45,42,42,40,40,38,37,36,35,34,33,32,30,30,28,28,27,26,24,23,22,21,21,19,19,17,17,16,15,13,12,11,10,10,8,8,6,6,5},
{91,88,86,85,81,80,77,76,73,71,69,68,66,64,63,60,60,57,56,55,53,52,50,49,47,47,44,44,42,41,40,39,37,36,35,34,33,31,31,29,28,27,26,25,24,23,22,21,19,19,17,17,16,15,14,13,11,10,10,8,8,6,6,5},
{105,101,98,96,91,89,86,84,81,79,76,74,71,69,68,65,64,61,60,58,56,54,53,51,49,49,46,46,43,43,41,40,38,37,36,34,34,32,31,29,29,28,27,25,24,23,22,22,19,19,17,17,16,15,14,13,12,10,10,8,8,6,6,5},
{117,113,109,106,101,98,93,91,88,85,82,79,76,74,72,69,67,64,63,61,59,57,55,53,51,50,48,47,44,44,42,41,39,38,36,35,35,32,32,30,29,28,27,26,24,23,22,22,20,19,17,17,16,15,14,13,12,10,10,8,8,6,6,5}
};

char track_id = 0;
char pos[4];
char turn = 4;
char *track_x_shift = (char *)track_x_shifts[4];
char *track_x_shift0 = (char *)track_x_shifts[4];
unsigned char landscape = 0;

int main () {
    int i;
    init_graphics();
    init_dynawave();
    init_music();

    flip_pages();
    clear_border(0);
    await_draw_queue();
    flip_pages();
    await_draw_queue();
    clear_border(0);

    load_spritesheet(&ASSET__crash__track_bmp, 0);
    load_spritesheet(&ASSET__crash__cars_bmp, 1);

    change_rom_bank(SAVE_BANK_NUM);
    pos[0] = saved_pos[0];
    pos[1] = saved_pos[1];
    pos[2] = saved_pos[2];
    pos[3] = saved_pos[3];

    while (1) {                                     //  Run forever
        clear_screen(0);

        draw_sprite(landscape, 0, 127-landscape, 48, 0, 0, 1);
        draw_sprite(0, 0, landscape, 48, 127-landscape, 0, 1);
        draw_box(0, 48, 127, 64, 27);
        for (i=63; i>=0; i--) {
            draw_sprite(track_x_shift[i], i+48, track_width[i], 1, track_x_shift0[i], tracks[track_id][i], 0);
        }
        draw_sprite(50, 90, 32, 16, 0, 49, 1);
        pos[1] += pos[2];
        pos[0] += pos[3];
        if(pos[1] == 1) {
            pos[2] = 1;
        } else if(pos[1] == 119) {
            pos[2] = -1;
        }
        if(pos[0] == 8) {
            pos[3] = 1;
        } else if(pos[0] == 112) {
            pos[3] = -1;
        }
        
        await_draw_queue();
        sleep(1);
        flip_pages();
        update_inputs();
        if(player1_buttons & INPUT_MASK_LEFT) {
            if (turn != 0) {
                turn--;
                track_x_shift = (char *)track_x_shifts[turn];
            }
        } else if (player1_buttons & INPUT_MASK_RIGHT) {
            if (turn != 8) {
                turn++;
                track_x_shift = (char *)track_x_shifts[turn];
            }
        }
play_sound_effect(&ASSET__sfx__sfx_bin , 1);
        if (player1_buttons & ~player1_old_buttons & INPUT_MASK_A) {
            play_sound_effect(&ASSET__sfx__sfx_bin , 1);
        }

        if (landscape < turn - 4) {
            landscape = landscape - turn + 132;
        } else {
            landscape = (landscape - turn + 4) % 128;
        }

//        set_note(34, 12);
        tick_music();

        track_id += 2;
        if (track_id == 20) track_id = 0;
    }

  return (0);                                     //  We should never get here!
}